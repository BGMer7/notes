# Load Balance 

## Introduction

当大型网站发展到一定的程度的时候，要面对庞大的用户量，高并发，海量数据等等挑战，为了提升系统的的性能，可以采用垂直扩展和水平扩展两种方式。

### 垂直扩展（提升性能）

在网站发展早期，可以从单机的角度通过增加硬件处理能力，比如 CPU 处理能力，内存容量，磁盘等方面，实现服务器处理能力的提升。但是，单机是有性能瓶颈的，一旦触及瓶颈，再想提升，付出的成本和代价会极高。这显然不能满足大型分布式系统（网站）所有应对的大流量，高并发，海量数据等挑战。

### 水平扩展（提升数量）

通过集群来分担大型网站的流量。集群中的应用服务器（节点）通常被设计成无状态，用户可以请求任何一个节点，这些节点共同分担访问压力。水平扩展有两个要点：

1. 应用集群：将一台应用部署到多台机器上，组成处理集群，接收负载均衡设备分发的请求，进行处理，并返回相应的数据。
2. 负载均衡：将用户的访问请求，通过某种算法分发到集群中的节点。

### LB的主要作用

目标是将网络流量平均分发到多个服务器上，以提高系统整体的相应速度和可用性。

> **负载均衡的主要作用：**
>
> **高并发(Concurrence)：**负载均衡通过算法调整负载，尽力均匀的分配应用集群中各节点的工作量，以此提高应用集群的并发处理能力（吞吐量）。
>
> **伸缩性(Elastic)：**增加或减少服务器数量，然后由负载均衡进行分发控制。这使得应用集群具备伸缩性。
>
> **高可用(HA)：**负载均衡器可以监控候选服务器，当服务器不可用时，自动跳过，将请求分发给可用的服务器。这使得应用集群具备高可用的特性。
>
> **安全防护(Security)：**有些负载均衡软件或硬件提供了安全性功能，如：黑白名单处理、防火墙，防DDoS攻击等。

## Categories

从负载均衡的载体来看，可以将负载均衡分为两类：**硬件负载均衡和软件负载均衡**

[深入浅出负载均衡 - 掘金 (juejin.cn)](https://juejin.cn/post/6970950695117651976)

### 硬件负载均衡

硬件负载均衡，一般是在定制处理器上运行的独立负载均衡服务器，价格昂贵，土豪专属。硬件负载均衡的主流产品有:F5 和 A10。

**硬件负载均衡的 优点：**

- 功能强大：支持全局负载均衡并提供较全面的、复杂的负载均衡算法。
- 性能强悍：硬件负载均衡由于是在专用处理器上运行，因此吞吐量大，可支持单机百万以上的并发。
- 安全性高：往往具备防火墙，防DDoS攻击等安全功能。

**硬件负载均衡的 缺点：**

- 成本昂贵：购买和维护硬件负载均衡的成本都很高。
- 扩展性差：当访问量突增时，超过限度不能动态扩容。

### 软件负载均衡

软件负载均衡，应用最广泛。

软件负载均衡从软件层面实现负载均衡，一般可以在任何标准物理设备上运行。

软件负载均衡主流产品：Nginx、HAProxy、LVS

- LVS 可以作为四层负载均衡器。其负载均衡的性能要优于 Nginx。
- HAProxy 可以作为 HTTP 和 TCP 负载均衡器。
- Nginx、HAProxy 可以作为四层或七层负载均衡器。

软件负载均衡的优点：

- 扩展性好：适应动态变化，可以通过添加软件负载均衡实例，动态扩展到超出初始容量的能力。
- 成本低廉：软件负载均衡可以在任何标准物理设备上运行，降低了购买和运维的成本。

软件负载均衡的 缺点：

- 性能略差：相比于硬件负载均衡，软件负载均衡的性能要略低一些。

### 网络通信分类

从网络通信分层的角度看，可以分为四层和七层负载均衡。

四层负载均衡：基于IP地址和端口进行请求的转发。

- DNS 重定向
- HTTP 重定向
- 反向代理

七层负载均衡：就是可以根据访问用户的 HTTP 请求头、URL 信息将请求转发到特定的主机。

- 修改 IP 地址
- 修改 MAC 地址

#### DNS负载均衡

DNS 负载均衡一般用于互联网公司，复杂的业务系统不适合使用。大型网站一般使用 DNS 负载均衡作为 第一级负载均衡手段，然后在内部使用其它方式做第二级负载均衡。DNS 负载均衡属于七层负载均衡。

DNS即域名解析系统，是OSI第七层网络协议，DNS被设计为一个树形结构的分布式应用，自上而下依次为：根服务服务器，一级域名服务器，二级域名服务器...本地域名服务器。显然，如果所有的数据都存储在根服务服务器，那么DNS查询的负载和开销会非常庞大。

因此，DNS查询相对于DNS，是一个逆向的递归过程，DNS客户端依次请求本地DNS服务器，上一级DNS服务器，上上一级DNS服务器，...，根DNS服务器（又叫权威DNS服务器），一旦命中，立即返回。为了减少查询次数，每一级DNS都会设置DNS查询缓存地址。

DNS负载均衡的工作原理就是：基于DNS查询缓存，按照负载情况返回不同服务器的 IP 地址。













#### HTTP负载均衡







#### 反向代理（Reverse Proxy）

反向代理（Reverse Proxy）方式是指以 代理服务器 来接受网络请求，然后 将请求转发给内网中的服务器，并将从内网中的服务器上得到的结果返回给网络请求的客户端。反向代理负载均衡属于七层负载均衡。

反向代理服务的主流产品：**Nginx、Apache**。

正向代理与反向代理有什么区别？

> 正向代理发生在客户端，是由用户主动发起的，翻墙软件就属于典型的主动代理，客户端通过主动访问代理服务器，让代理服务器去访问需要的外网数据，再将数据返回给客户端。
>
> 反向代理发生在服务端，用户并不知道代理的存在，但是服务器会将请求分发给别的服务器，别的服务器再返回数据给这个服务器，最终将数据返回客户端，客户端至始至终只是和一个服务器打交道。













#### IP负载均衡











### 随机









### 轮询

#### 轮询算法





#### 加权轮询算法









### 最小活跃数







### IP哈希































## Nginx

[Nginx和F5区别 - 云+社区 - 腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1404473)

Nginx：高性能的 HTTP和反向代理服务器，同时支持作为IMAP/POP3/SMTP代理服务器。

例如腾讯、淘宝、新浪等大型门户及商业网站都采用Nginx进行HTTP网站的数据分流。

### Nginx功能特点

1. 工作在网络层第七层，可以针对http应用做一些分流，例如针对域名、针对目录
2. Nginx对于网络的依赖比较小
3. Nginx安装和配置比较简单，测试起来比较方便
4. 可以承担高的负载压力且稳定，一般能承受超过1万次的并发
5. Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测；
6. Nginx对请求的异步处理可以帮助节点服务器减轻负载
7. Nginx能支持http和email

### 软负载

优点：基于系统与应用的负载均衡，能够更好地根据系统与应用的状况来分配负载。这对于复杂应用是很重要的，性价比高，实际上如果几台服务器，用F5之类的硬件产品显得有些浪费，而用软件就要合算得多，因为服务器同时还可以跑应用、做集群等。

缺点：负载能力受服务器本身性能的影响，性能越好，负载能力越大。



### 反向代理

Nginx采用的是反向代理技术，代理服务器来接受Internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。反向代理负载均衡技术是把将来自internet上的连接请求以反向代理的方式动态地转发给内部网络上的多台服务器进行处理，从而达到负载均衡的目的。

具体是怎么运行的呢？其实当Nginx启动后，其工作进程是由配置文件对其进行初始化的，主进程处理配置文件中的读取、端口绑定等特权操作，之后创建一小组子进程，由这些子进程进行请求的处理，同时缓存加载器加载硬盘中缓存到内存中，接着退出，保证资源开销始终保持着较低的状态。





### 负载均衡策略

内置策略为轮询、加权轮询、IP哈希。







## F5











